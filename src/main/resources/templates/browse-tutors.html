<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Tutors - Qiwi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #3d3f5c;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
        }

        /* SMOOTH ANIMATIONS */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .navbar {
            background: #3d3f5c;
            padding: 1.25rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border-bottom: 1px solid rgba(244, 209, 174, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            color: #f4d1ae;
            font-size: 1.5rem;
            font-weight: 700;
            text-decoration: none;
            letter-spacing: -0.02em;
            transition: all 0.3s ease;
        }

        .logo:hover {
            transform: translateY(-2px);
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: rgba(244, 209, 174, 0.9);
            text-decoration: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
            letter-spacing: -0.01em;
        }

        .nav-links a:hover {
            background-color: rgba(244, 209, 174, 0.15);
            color: #f4d1ae;
            transform: translateY(-1px);
        }

        .nav-links a.active {
            background-color: rgba(244, 209, 174, 0.2);
            color: #f4d1ae;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-role-badge {
            background: rgba(244, 209, 174, 0.2);
            color: #f4d1ae;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(244, 209, 174, 0.9);
        }

        .user-dropdown {
            position: relative;
        }

        .user-menu-btn {
            background: rgba(244, 209, 174, 0.1);
            border: 1px solid rgba(244, 209, 174, 0.25);
            color: #f4d1ae;
            padding: 0.6rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .user-menu-btn:hover {
            background: rgba(244, 209, 174, 0.15);
            border-color: rgba(244, 209, 174, 0.35);
            transform: translateY(-1px);
        }

        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
            margin-top: 0.5rem;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .user-dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        @keyframes dropdownFadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-dropdown-menu a {
            display: block;
            padding: 0.875rem 1.25rem;
            color: #374151;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .user-dropdown-menu a:hover {
            background: #f9fafb;
            padding-left: 1.5rem;
        }

        .user-dropdown-menu a:last-child {
            border-bottom: none;
        }

        .logout-link {
            color: #dc2626 !important;
            font-weight: 500;
        }

        .logout-link:hover {
            background: #fef2f2 !important;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 20px;
        }

        .page-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
            animation: fadeInUp 0.6s ease;
        }

        .page-header h1 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .page-header p {
            color: #4a5568;
            margin-bottom: 2rem;
            font-size: 1rem;
            line-height: 1.5;
        }

        .booking-mode-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
            font-weight: 500;
        }

        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            animation: fadeInUp 0.6s ease 0.1s both;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .filter-control {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafbfc;
            color: #2d3748;
        }

        .filter-control:focus {
            outline: none;
            border-color: #cbd5e0;
            background: white;
            box-shadow: 0 0 0 3px rgba(203, 213, 224, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            letter-spacing: -0.01em;
        }

        .btn-primary {
            background: #3d3f5c;
            color: white;
        }

        .btn-primary:hover {
            background: #2d2f3c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(61, 63, 92, 0.3);
        }

        .btn-secondary {
            background: #f9fafb;
            color: #4a5568;
            border: 1px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f3f4f6;
            color: #374151;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border-color: #cbd5e0;
        }

        .tutors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            animation: fadeInUp 0.6s ease 0.2s both;
        }

        @media (min-width: 1200px) {
            .tutors-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }

        @media (min-width: 1600px) {
            .tutors-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .tutor-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .tutor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .tutor-header {
            margin-bottom: 1rem;
        }

        .tutor-info h3 {
            color: #2d3748;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .tutor-info .major {
            color: #4a5568;
            font-size: 0.9rem;
        }

        .tutor-subjects {
            margin-bottom: 1rem;
        }

        .tutor-subjects h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .subjects-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .subject-tag {
            background: rgba(61, 63, 92, 0.1);
            color: #3d3f5c;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .expertise-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .expertise-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-excellent {
            background: #d4edda;
            color: #155724;
        }

        .badge-good {
            background: #fff3cd;
            color: #856404;
        }

        .tutor-approach {
            margin-bottom: 1.5rem;
            flex-grow: 1;
        }

        .tutor-approach h4 {
            color: #2d3748;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .approach-text {
            color: #4a5568;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 4.5rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .tutor-actions {
            display: flex;
            gap: 1rem;
        }

        .contact-btn {
            width: 100%;
            background: #3d3f5c;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            letter-spacing: -0.01em;
        }

        .contact-btn:hover {
            background: #2d2f3c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(61, 63, 92, 0.3);
        }

        .contact-btn.booking-mode {
            background: #059669;
        }

        .contact-btn.booking-mode:hover {
            background: #047857;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .tutor-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .meta-value {
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #4a5568;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
            color: #9ca3af;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3d3f5c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Booking Modal Styles */
        .booking-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .booking-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .booking-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .booking-modal-header h3 {
            color: #2d3748;
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: #2d3748;
            background: #f9fafb;
        }

        .booking-form {
            margin-top: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafbfc;
            color: #2d3748;
        }

        .form-control:focus {
            outline: none;
            border-color: #cbd5e0;
            background: white;
            box-shadow: 0 0 0 3px rgba(203, 213, 224, 0.1);
        }

        .booking-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* FOOTER */
        .footer {
            background: #2d3748;
            color: rgba(244, 209, 174, 0.8);
            text-align: center;
            padding: 3rem 0;
            margin-top: 4rem;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .footer-text {
            font-size: 0.9rem;
            color: rgba(244, 209, 174, 0.8);
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .footer-links a {
            color: rgba(244, 209, 174, 0.9);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .footer-links a:hover {
            color: #f4d1ae;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .navbar .container {
                flex-wrap: wrap;
                gap: 1rem;
                padding: 0 20px;
            }

            .nav-links {
                order: 3;
                width: 100%;
                justify-content: center;
                gap: 1.5rem;
            }

            .container {
                padding: 2rem 20px;
            }

            .tutors-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .user-section {
                gap: 1rem;
            }

            .booking-modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .booking-actions {
                flex-direction: column;
            }

            .page-header {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="container">
        <a href="/" class="logo">Qiwi</a>

        <ul class="nav-links" id="navLinks">
            <li><a href="#" id="dashboardLink">Dashboard</a></li>
            <li><a href="#" id="profileNavLink">My Profile</a></li>
            <li><a href="#" id="browseTutorsLink" class="active">Find Tutors</a></li>
            <li><a href="#" id="messagesLink">Messages</a></li>
        </ul>

        <!-- User Info -->
        <div class="user-section" id="userSection">
            <span class="user-role-badge" id="userRoleBadge">Student</span>
            <div class="user-info">
                <div class="user-dropdown">
                    <button class="user-menu-btn" onclick="toggleUserMenu()">
                        <span id="userName">User</span>
                    </button>
                    <div class="user-dropdown-menu" id="userDropdownMenu">
                        <a href="#" onclick="editProfile()" id="profileLink">Edit Profile</a>
                        <a href="#" onclick="logout()" class="logout-link">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container">
    <div class="page-header">
        <h1 id="pageTitle">Find Your Perfect Tutor</h1>
        <p id="pageDescription">Connect with experienced tutors who can help you excel in your studies</p>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="majorFilter">Filter by Major</label>
                <select id="majorFilter" class="filter-control" onchange="applyFilters()">
                    <option value="">All Majors</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="subjectFilter">Filter by Subject</label>
                <select id="subjectFilter" class="filter-control" onchange="applyFilters()">
                    <option value="">All Subjects</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchInput">Search Tutors</label>
                <input type="text" id="searchInput" class="filter-control" placeholder="Search by name or subject..." oninput="applyFilters()">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset Filters</button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Finding the best tutors for you...</p>
    </div>

    <!-- Tutors Grid -->
    <div id="tutorsGrid" class="tutors-grid">
        <!-- Tutors will be populated by JavaScript -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="icon">Search</div>
        <h3>No tutors found</h3>
        <p>Try adjusting your filters or search terms</p>
    </div>
</div>

<!-- FOOTER -->
<footer class="footer">
    <div class="footer-content">
        <div class="footer-links">
            <a href="/about">About Qiwi</a>
            <a href="/privacy">Privacy Policy</a>
            <a href="/terms">Terms of Service</a>
            <a href="https://www.linkedin.com/company/qiwiedu/posts/?feedView=all" target="_blank" rel="noopener noreferrer">LinkedIn</a>
            <a href="mailto:support@qiwi.com">Email Us</a>
        </div>
        <p class="footer-text">© 2024 Qiwi. Connecting university students through peer tutoring.</p>
    </div>
</footer>

<script th:inline="javascript">
    const userId = /*[[${userId}]]*/ '';
    const API_BASE = '/api';
    let currentUser = null;
    let allTutors = [];
    let filteredTutors = [];
    let isBookingMode = false;

    // Initialize page
    window.addEventListener('load', async function() {
        console.log('Browse tutors loading with userId:', userId);

        if (!userId) {
            console.log('No userId found, redirecting to login');
            window.location.href = '/login';
            return;
        }

        // Check if we're in booking mode
        const urlParams = new URLSearchParams(window.location.search);
        isBookingMode = urlParams.get('booking') === 'true';

        await loadUserData();
        updateNavigation();

        if (isBookingMode) {
            setupBookingMode();
        }

        await loadTutors();

        console.log('Browse tutors loaded successfully');
    });

    async function loadUserData() {
        try {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                console.log('Loaded user from localStorage:', currentUser);
            } else if (userId) {
                currentUser = {
                    id: userId,
                    name: 'Student',
                    role: 'TUTEE'
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('Created user object:', currentUser);
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }

    function setupBookingMode() {
        console.log('Setting up booking mode');

        // Update page title and description
        document.getElementById('pageTitle').textContent = 'Book a Tutoring Session';
        document.getElementById('pageDescription').textContent = 'Browse available tutors and request a session at your preferred time';

        // Show booking banner
        document.getElementById('bookingBanner').style.display = 'block';

        isBookingMode = true;
    }

    function updateNavigation() {
        if (!currentUser) {
            console.error('No current user for navigation update');
            return;
        }

        console.log('Updating navigation for user:', currentUser);

        // Update user display elements
        const userName = document.getElementById('userName');
        const userRoleBadge = document.getElementById('userRoleBadge');

        if (userName) {
            userName.textContent = currentUser.name || 'Student';
        }

        if (userRoleBadge) {
            userRoleBadge.textContent = currentUser.role === 'TUTOR' ? 'Tutor' : 'Student';
        }

        // Update navigation links
        updateNavigationLinks();
    }

    function updateNavigationLinks() {
        const dashboardLink = document.getElementById('dashboardLink');
        const browseTutorsLink = document.getElementById('browseTutorsLink');
        const profileNavLink = document.getElementById('profileNavLink');
        const messagesLink = document.getElementById('messagesLink');
        const profileLink = document.getElementById('profileLink');

        if (dashboardLink) {
            dashboardLink.href = `/dashboard?userId=${currentUser.id}&role=${currentUser.role}`;
            dashboardLink.onclick = (e) => { e.preventDefault(); navigateTo(`/dashboard?userId=${currentUser.id}&role=${currentUser.role}`); };
        }

        if (browseTutorsLink) {
            browseTutorsLink.href = `/browse-tutors?userId=${currentUser.id}`;
            browseTutorsLink.onclick = (e) => { e.preventDefault(); navigateTo(`/browse-tutors?userId=${currentUser.id}`); };
        }

        if (messagesLink) {
            messagesLink.href = `/messages?userId=${currentUser.id}`;
            messagesLink.onclick = (e) => { e.preventDefault(); navigateTo(`/messages?userId=${currentUser.id}`); };
        }

        // Role-based profile links
        if (currentUser.role === 'TUTOR') {
            if (profileNavLink) {
                profileNavLink.textContent = 'My Profile';
                profileNavLink.href = `/tutor-profile?userId=${currentUser.id}`;
                profileNavLink.onclick = (e) => { e.preventDefault(); navigateTo(`/tutor-profile?userId=${currentUser.id}`); };
            }
            if (profileLink) {
                profileLink.href = `/tutor-profile?userId=${currentUser.id}`;
            }
        } else {
            if (profileNavLink) {
                profileNavLink.textContent = 'My Profile';
                profileNavLink.href = `/tutee-profile?userId=${currentUser.id}`;
                profileNavLink.onclick = (e) => { e.preventDefault(); navigateTo(`/tutee-profile?userId=${currentUser.id}`); };
            }
            if (profileLink) {
                profileLink.href = `/tutee-profile?userId=${currentUser.id}`;
            }
        }
    }

    async function loadTutors() {
        showLoading();

        try {
            const response = await fetch(`${API_BASE}/tutors`);
            if (response.ok) {
                allTutors = await response.json();
                filteredTutors = [...allTutors];

                populateFilters();
                displayTutors(filteredTutors);
                updateStats();

                console.log(`Loaded ${allTutors.length} tutors`);
            } else {
                throw new Error('Failed to load tutors');
            }
        } catch (error) {
            console.error('Error loading tutors:', error);
            showError('Failed to load tutors. Please try again.');
        } finally {
            hideLoading();
        }
    }



    function populateFilters() {
        const majorFilter = document.getElementById('majorFilter');
        const subjectFilter = document.getElementById('subjectFilter');

        // Get unique majors from tutors
        const majors = [...new Set(allTutors.map(t => t.major))].sort();

        // Updated subjects based on your course chart
        const courseSubjects = [
            // Bac 1 - Q1
            'CORP_FIN', 'MARKETING', 'MATH_ANAL', 'CHEM_ENV1',
            // Bac 1 - Q2
            'FIN_ACC', 'DATA_PROB', 'MATH_ALG',
            // Bac 1 - Q1&Q2
            'PHYS_EN1', 'ENGLISH1',
            // Bac 2 - Q1
            'MACRO', 'MICRO', 'DATA_STAT', 'PROG_ECO', 'PHYS_EN2', 'LAW_BUS',
            // Bac 2 - Q2
            'MGMT_SCI', 'CHEM_ENV2',
            // Bac 3 - Q1
            'DIGI_ECO', 'BIG_DATA', 'TECH_DEV1', 'ECO_HIST',
            // Bac 3 - Q2
            'FIN_INFO', 'TECH_DEV2'
        ];

        // Subject display mapping from your chart
        const subjectDisplayMap = {
            'CORP_FIN': { code: 'lecge1108', name: 'Économie politique' },
            'MARKETING': { code: 'ling1108', name: 'Marketing' },
            'MATH_ANAL': { code: 'ling1114', name: 'Introduction à la modélisation mathématiques : analyse' },
            'CHEM_ENV1': { code: 'ling1115', name: 'Chimie et environnement I' },
            'FIN_ACC': { code: 'ling1107', name: 'Comptabilité financière et analyse des états financiers' },
            'DATA_PROB': { code: 'ling1113', name: 'Analyse de données : Probabilités' },
            'MATH_ALG': { code: 'ling1121', name: 'Introduction à la modélisation mathématique : algèbre' },
            'PHYS_EN1': { code: 'ling1122', name: 'Physique et énergie I' },
            'ENGLISH1': { code: 'lang1330', name: 'Anglais niveau moyen 1ère partie' },
            'MACRO': { code: 'lecge1212', name: 'Macroéconomie' },
            'MICRO': { code: 'lecge1222', name: 'Microéconomie' },
            'DATA_STAT': { code: 'ling1214', name: 'Analyse de données : Statistiques' },
            'PROG_ECO': { code: 'ling1225', name: 'Programmation en économie et gestion' },
            'PHYS_EN2': { code: 'ling1213', name: 'Physique et énergie II' },
            'LAW_BUS': { code: 'lespo1221', name: 'Droit, entreprise et fiscalité' },
            'MGMT_SCI': { code: 'ling1216', name: 'Management sciences : modèles déterministes' },
            'CHEM_ENV2': { code: 'ling1223', name: 'Chimie et environnement II' },
            'DIGI_ECO': { code: 'lecge1303', name: 'Digital economics' },
            'BIG_DATA': { code: 'lecge1301', name: 'Analyse de données : nouvelles méthodes (Big Data, IA)' },
            'TECH_DEV1': { code: 'ling1317', name: 'Recherche et développement technologique : énergie, électronique et télécommunications' },
            'ECO_HIST': { code: 'lecge1217', name: 'History of Economic Theory' },
            'FIN_INFO': { code: 'ling1322', name: 'Finance and information systems' },
            'TECH_DEV2': { code: 'ling1327', name: 'Recherche et développement technologique : mécanique, procédés chimiques et matériaux' }
        };

        // Populate major filter
        majorFilter.innerHTML = '<option value="">All Majors</option>' +
            majors.map(major => `<option value="${major}">${major.replace(/_/g, ' ')}</option>`).join('');

        // Populate subject filter using courseSubjects order
        subjectFilter.innerHTML = '<option value="">All Subjects</option>' +
            courseSubjects.map(subject => {
                const display = subjectDisplayMap[subject] || { code: subject.toLowerCase(), name: subject.replace(/_/g, ' ') };
                return `<option value="${subject}">${display.code} - ${display.name}</option>`;
            }).join('');
    }




    function displayTutors(tutors) {
        const grid = document.getElementById('tutorsGrid');
        const emptyState = document.getElementById('emptyState');

        if (tutors.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        grid.style.display = 'grid';
        emptyState.style.display = 'none';

        grid.innerHTML = tutors.map(tutor => createTutorCard(tutor)).join('');

        // Update button text if in booking mode
        if (isBookingMode) {
            setTimeout(() => {
                document.querySelectorAll('.contact-btn').forEach(btn => {
                    btn.textContent = btn.textContent.replace('Contact', 'Book Session with');
                    btn.classList.add('booking-mode');
                });
            }, 100);
        }
    }



    function createTutorCard(tutor) {
        // Map the enum names to display course code and name
        const subjectDisplayMap = {
            'CORP_FIN': { code: 'lecge1108', name: 'Économie politique' },
            'MARKETING': { code: 'ling1108', name: 'Marketing' },
            'MATH_ANAL': { code: 'ling1114', name: 'Introduction à la modélisation mathématiques : analyse' },
            'CHEM_ENV1': { code: 'ling1115', name: 'Chimie et environnement I' },
            'FIN_ACC': { code: 'ling1107', name: 'Comptabilité financière et analyse des états financiers' },
            'DATA_PROB': { code: 'ling1113', name: 'Analyse de données : Probabilités' },
            'MATH_ALG': { code: 'ling1121', name: 'Introduction à la modélisation mathématique : algèbre' },
            'PHYS_EN1': { code: 'ling1122', name: 'Physique et énergie I' },
            'ENGLISH1': { code: 'lang1330', name: 'Anglais niveau moyen 1ère partie' },
            'MACRO': { code: 'lecge1212', name: 'Macroéconomie' },
            'MICRO': { code: 'lecge1222', name: 'Microéconomie' },
            'DATA_STAT': { code: 'ling1214', name: 'Analyse de données : Statistiques' },
            'PROG_ECO': { code: 'ling1225', name: 'Programmation en économie et gestion' },
            'PHYS_EN2': { code: 'ling1213', name: 'Physique et énergie II' },
            'LAW_BUS': { code: 'lespo1221', name: 'Droit, entreprise et fiscalité' },
            'MGMT_SCI': { code: 'ling1216', name: 'Management sciences : modèles déterministes' },
            'CHEM_ENV2': { code: 'ling1223', name: 'Chimie et environnement II' },
            'DIGI_ECO': { code: 'lecge1303', name: 'Digital economics' },
            'BIG_DATA': { code: 'lecge1301', name: 'Analyse de données : nouvelles méthodes (Big Data, IA)' },
            'TECH_DEV1': { code: 'ling1317', name: 'Recherche et développement technologique : énergie, électronique et télécommunications' },
            'ECO_HIST': { code: 'lecge1217', name: 'History of Economic Theory' },
            'FIN_INFO': { code: 'ling1322', name: 'Finance and information systems' },
            'TECH_DEV2': { code: 'ling1327', name: 'Recherche et développement technologique : mécanique, procédés chimiques et matériaux' }
        };

        const gradeDisplays = tutor.grades ? Object.entries(tutor.grades).map(([subject, grade]) => {
            const subjectDisplay = subjectDisplayMap[subject] || { code: subject.toLowerCase(), name: subject.replace(/_/g, ' ') };
            const gradeText = grade === 'first_try' ? 'First Try' : 'After Retake';
            const badgeClass = grade === 'first_try' ? 'badge-excellent' : 'badge-good';
            return `<span class="expertise-badge ${badgeClass}">${subjectDisplay.code}: ${gradeText}</span>`;
        }).join('') : '';

        return `
      <div class="tutor-card">
        <div class="tutor-header">
          <div class="tutor-info">
            <h3>${tutor.name}</h3>
            <div class="major">${tutor.major ? tutor.major.replace(/_/g, ' ') : 'Not specified'}</div>
          </div>
        </div>

        <div class="tutor-subjects">
          <h4>Subjects</h4>
          <div class="subjects-list">
            ${tutor.subjects.map(subject => {
            const display = subjectDisplayMap[subject] || { code: subject.toLowerCase(), name: subject.replace(/_/g, ' ') };
            return `<span class="subject-tag">${display.code} - ${display.name}</span>`;
        }).join('')}
          </div>
          ${gradeDisplays ? `<div class="expertise-badges">${gradeDisplays}</div>` : ''}
        </div>

        <div class="tutor-approach">
          <h4>Teaching Approach</h4>
          <div class="approach-text">
            ${tutor.teachingApproach || 'No teaching approach provided.'}
          </div>
        </div>

        <div class="tutor-actions">
          <button class="contact-btn" onclick="contactTutor(${tutor.id}, '${tutor.name.replace(/'/g, "\\'")}')">
            ${isBookingMode ? 'Book Session with' : 'Contact'} ${tutor.name}
          </button>
        </div>

        <div class="tutor-meta">
          <div class="meta-item">
            <span class="meta-icon">Subjects:</span>
            <span>${tutor.subjects.length}</span>
          </div>
          <div class="meta-item">
            <span class="meta-icon">Status:</span>
            <span>Available</span>
          </div>
        </div>
      </div>
    `;
    }




    function contactTutor(tutorId, tutorName) {
        console.log('Contacting tutor:', tutorName, 'ID:', tutorId);
        if (!currentUser) {
            console.error('No current user for contact');
            return;
        }

        if (isBookingMode) {
            showBookingModal(tutorId, tutorName);
        } else {
            const messagesUrl = `/messages?userId=${currentUser.id}&contactId=${tutorId}&contactName=${encodeURIComponent(tutorName)}`;
            console.log('Navigating to messages:', messagesUrl);
            window.location.href = messagesUrl;
        }
    }

    function showBookingModal(tutorId, tutorName) {
        const modal = document.createElement('div');
        modal.className = 'booking-modal';
        modal.innerHTML = `
      <div class="booking-modal-content" style="max-width: 700px;">
        <div class="booking-modal-header">
          <h3>Request Session with ${tutorName}</h3>
          <button class="close-btn" onclick="closeBookingModal()">×</button>
        </div>

        <div style="background: #e8f4fd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #3d3f5c;">
          <div style="font-weight: 500; color: #1565c0; margin-bottom: 0.5rem;">How Booking Works</div>
          <div style="color: #333; font-size: 0.9rem;">
            Choose your preferred date and time below. Your request will be sent to ${tutorName} for approval.
            You'll be notified once they confirm or suggest an alternative time.
          </div>
        </div>

        <div class="booking-form">
          <div class="form-group">
            <label for="sessionSubject">Subject:</label>
            <select id="sessionSubject" class="form-control" required>
              <option value="">Select a subject</option>
            </select>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
              <label for="sessionDate">Preferred Date:</label>
              <input type="date" id="sessionDate" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="sessionDuration">Session Duration:</label>
              <select id="sessionDuration" class="form-control" required>
                <option value="">Select duration</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="90">1.5 hours</option>
                <option value="120">2 hours</option>
              </select>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
              <label for="startTime">Preferred Start Time:</label>
              <input type="time" id="startTime" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="endTime">End Time:</label>
              <input type="time" id="endTime" class="form-control" readonly style="background: #f8f9fa;">
            </div>
          </div>

          <div class="form-group">
            <label for="alternativeTimes">Alternative Times (optional):</label>
            <textarea id="alternativeTimes" class="form-control" style="height: 60px;"
              placeholder="e.g., 'Also available Monday 2-4pm or Tuesday morning'"></textarea>
          </div>

          <div class="form-group">
            <label for="studentNotes">What do you need help with?</label>
            <textarea id="studentNotes" class="form-control" style="height: 80px;"
              placeholder="Describe the topics, specific problems, or concepts you'd like to work on..." required></textarea>
          </div>

          <div class="form-group">
            <label for="sessionLocation">Preferred Location:</label>
            <select id="sessionLocation" class="form-control">
              <option value="">Select location preference</option>
              <option value="Online (Video Call)">Online (Video Call)</option>
              <option value="Library">Campus Library</option>
              <option value="Student Center">Student Center</option>
              <option value="Coffee Shop">Coffee Shop</option>
              <option value="Tutor's Choice">Let tutor decide</option>
              <option value="Other">Other (specify in notes)</option>
            </select>
          </div>

          <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #ffc107;">
            <div style="font-weight: 500; color: #856404; margin-bottom: 0.5rem;">Quick Tip</div>
            <div style="color: #856404; font-size: 0.9rem;">
              Provide alternative times and detailed notes to increase your chances of getting confirmed quickly!
            </div>
          </div>

          <div class="booking-actions">
            <button class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitBookingRequest()">Send Request to ${tutorName}</button>
          </div>
        </div>
      </div>
    `;

        document.body.appendChild(modal);
        window.currentBookingModal = modal;
        window.selectedTutorId = tutorId;
        window.selectedTutorName = tutorName;

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('sessionDate').min = today;
        document.getElementById('sessionDate').value = today;

        // Set default time to current time + 1 hour
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const defaultTime = now.toTimeString().slice(0, 5);
        document.getElementById('startTime').value = defaultTime;

        // Load tutor's subjects
        loadTutorSubjects(tutorId);

        // Add event listeners for automatic end time calculation
        setupTimeCalculation();
    }

    function setupTimeCalculation() {
        const startTimeInput = document.getElementById('startTime');
        const durationSelect = document.getElementById('sessionDuration');
        const endTimeInput = document.getElementById('endTime');

        function calculateEndTime() {
            const startTime = startTimeInput.value;
            const duration = parseInt(durationSelect.value);

            if (startTime && duration) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0, 0);

                const endDate = new Date(startDate.getTime() + duration * 60000);
                const endTimeString = endDate.toTimeString().slice(0, 5);
                endTimeInput.value = endTimeString;
            }
        }

        startTimeInput.addEventListener('change', calculateEndTime);
        durationSelect.addEventListener('change', calculateEndTime);
    }

    async function loadTutorSubjects(tutorId) {
        try {
            // Find tutor in our loaded data
            const tutor = allTutors.find(t => t.id === tutorId);
            if (tutor && tutor.subjects) {
                populateSubjectDropdown(tutor.subjects);
            } else {
                // Fallback: fetch from API
                const response = await fetch(`${API_BASE}/tutors/user/${tutorId}`);
                if (response.ok) {
                    const tutorData = await response.json();
                    populateSubjectDropdown(tutorData.subjects || []);
                }
            }
        } catch (error) {
            console.error('Error loading tutor subjects:', error);
            // Provide a default dropdown
            populateSubjectDropdown([]);
        }
    }



    function populateSubjectDropdown(subjects) {
        const subjectDisplayMap = {
            'CORP_FIN': { code: 'lecge1108', name: 'Économie politique' },
            'MARKETING': { code: 'ling1108', name: 'Marketing' },
            'MATH_ANAL': { code: 'ling1114', name: 'Introduction à la modélisation mathématiques : analyse' },
            'CHEM_ENV1': { code: 'ling1115', name: 'Chimie et environnement I' },
            'FIN_ACC': { code: 'ling1107', name: 'Comptabilité financière et analyse des états financiers' },
            'DATA_PROB': { code: 'ling1113', name: 'Analyse de données : Probabilités' },
            'MATH_ALG': { code: 'ling1121', name: 'Introduction à la modélisation mathématique : algèbre' },
            'PHYS_EN1': { code: 'ling1122', name: 'Physique et énergie I' },
            'ENGLISH1': { code: 'lang1330', name: 'Anglais niveau moyen 1ère partie' },
            'MACRO': { code: 'lecge1212', name: 'Macroéconomie' },
            'MICRO': { code: 'lecge1222', name: 'Microéconomie' },
            'DATA_STAT': { code: 'ling1214', name: 'Analyse de données : Statistiques' },
            'PROG_ECO': { code: 'ling1225', name: 'Programmation en économie et gestion' },
            'PHYS_EN2': { code: 'ling1213', name: 'Physique et énergie II' },
            'LAW_BUS': { code: 'lespo1221', name: 'Droit, entreprise et fiscalité' },
            'MGMT_SCI': { code: 'ling1216', name: 'Management sciences : modèles déterministes' },
            'CHEM_ENV2': { code: 'ling1223', name: 'Chimie et environnement II' },
            'DIGI_ECO': { code: 'lecge1303', name: 'Digital economics' },
            'BIG_DATA': { code: 'lecge1301', name: 'Analyse de données : nouvelles méthodes (Big Data, IA)' },
            'TECH_DEV1': { code: 'ling1317', name: 'Recherche et développement technologique : énergie, électronique et télécommunications' },
            'ECO_HIST': { code: 'lecge1217', name: 'History of Economic Theory' },
            'FIN_INFO': { code: 'ling1322', name: 'Finance and information systems' },
            'TECH_DEV2': { code: 'ling1327', name: 'Recherche et développement technologique : mécanique, procédés chimiques et matériaux' }
        };

        const select = document.getElementById('sessionSubject');
        if (subjects.length > 0) {
            select.innerHTML = '<option value="">Select a subject</option>' +
                subjects.map(subject => {
                    const display = subjectDisplayMap[subject] || { code: subject.toLowerCase(), name: subject.replace(/_/g, ' ') };
                    return `<option value="${subject}">${display.code} - ${display.name}</option>`;
                }).join('');
        } else {
            select.innerHTML = '<option value="">No subjects available</option>';
        }
    }






    async function submitBookingRequest() {
        const subject = document.getElementById('sessionSubject').value;
        const sessionDate = document.getElementById('sessionDate').value;
        const startTime = document.getElementById('startTime').value;
        const duration = document.getElementById('sessionDuration').value;
        const alternativeTimes = document.getElementById('alternativeTimes').value;
        const notes = document.getElementById('studentNotes').value;
        const location = document.getElementById('sessionLocation').value;

        // Validation
        if (!subject) {
            showBookingAlert('Please select a subject', 'error');
            return;
        }
        if (!sessionDate) {
            showBookingAlert('Please select a date', 'error');
            return;
        }
        if (!startTime) {
            showBookingAlert('Please select a start time', 'error');
            return;
        }
        if (!duration) {
            showBookingAlert('Please select session duration', 'error');
            return;
        }
        if (!notes.trim()) {
            showBookingAlert('Please describe what you need help with', 'error');
            return;
        }

        // Create start and end datetime
        const startDateTime = new Date(`${sessionDate}T${startTime}`);
        const endDateTime = new Date(startDateTime.getTime() + parseInt(duration) * 60000);

        // Check if the requested time is in the future
        if (startDateTime <= new Date()) {
            showBookingAlert('Please select a future date and time', 'error');
            return;
        }

        // Show loading state
        const submitBtn = event.target;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sending Request...';
        submitBtn.disabled = true;

        try {
            // Prepare detailed notes with alternative times
            let detailedNotes = notes.trim();
            if (alternativeTimes.trim()) {
                detailedNotes += `\n\nAlternative times: ${alternativeTimes.trim()}`;
            }

            const response = await fetch(`${API_BASE}/sessions/book`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tutorId: parseInt(window.selectedTutorId),
                    studentId: parseInt(currentUser.id),
                    subject: subject,
                    startTime: startDateTime.toISOString(),
                    endTime: endDateTime.toISOString(),
                    studentNotes: detailedNotes,
                    location: location || 'To be discussed'
                })
            });

            if (response.ok) {
                showSuccessModal();
            } else {
                const errorText = await response.text();
                showBookingAlert(errorText || 'Failed to send booking request', 'error');
            }
        } catch (error) {
            console.error('Error sending booking request:', error);
            showBookingAlert('An error occurred while sending your request', 'error');
        } finally {
            // Reset button state
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }

    function showSuccessModal() {
        closeBookingModal();

        const successModal = document.createElement('div');
        successModal.className = 'booking-modal';
        successModal.innerHTML = `
      <div class="booking-modal-content" style="max-width: 500px; text-align: center;">
        <div style="color: #059669; font-size: 4rem; margin-bottom: 1rem;">Success</div>
        <h3 style="color: #059669; margin-bottom: 1rem;">Request Sent Successfully!</h3>

        <div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: left;">
          <div style="font-weight: 500; color: #155724; margin-bottom: 0.5rem;">What happens next:</div>
          <div style="color: #155724; font-size: 0.9rem; line-height: 1.6;">
            1. <strong>${window.selectedTutorName}</strong> will receive your session request<br>
            2. They'll review your preferred time and details<br>
            3. You'll get notified when they confirm or suggest alternatives<br>
            4. Check your dashboard for updates!
          </div>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: center;">
          <button class="btn btn-secondary" onclick="closeSuccessModal()">
            Continue Browsing
          </button>
          <button class="btn btn-primary" onclick="goToDashboard()">
            View My Requests
          </button>
        </div>
      </div>
    `;

        document.body.appendChild(successModal);
        window.currentSuccessModal = successModal;
    }

    function closeSuccessModal() {
        if (window.currentSuccessModal) {
            document.body.removeChild(window.currentSuccessModal);
            window.currentSuccessModal = null;
        }
    }

    function goToDashboard() {
        window.location.href = `/dashboard?userId=${currentUser.id}&role=${currentUser.role}`;
    }

    function closeBookingModal() {
        if (window.currentBookingModal) {
            document.body.removeChild(window.currentBookingModal);
            window.currentBookingModal = null;
            window.selectedTutorId = null;
            window.selectedTutorName = null;
        }
    }

    function showBookingAlert(message, type) {
        // Remove existing alerts
        const existingAlert = document.querySelector('.booking-alert');
        if (existingAlert) {
            existingAlert.remove();
        }

        const alert = document.createElement('div');
        alert.className = 'booking-alert';
        alert.style.cssText = `
      position: fixed; top: 20px; right: 20px; z-index: 10001;
      padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500;
      background: ${type === 'success' ? '#059669' : '#dc3545'};
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
        alert.textContent = message;

        document.body.appendChild(alert);
        setTimeout(() => {
            if (document.body.contains(alert)) {
                document.body.removeChild(alert);
            }
        }, 5000);
    }

    function applyFilters() {
        const majorFilter = document.getElementById('majorFilter').value;
        const subjectFilter = document.getElementById('subjectFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();

        filteredTutors = allTutors.filter(tutor => {
            const matchesMajor = !majorFilter || tutor.major === majorFilter;
            const matchesSubject = !subjectFilter || tutor.subjects.includes(subjectFilter);
            const matchesSearch = !searchInput ||
                tutor.name.toLowerCase().includes(searchInput) ||
                tutor.subjects.some(subject => subject.toLowerCase().includes(searchInput)) ||
                (tutor.teachingApproach && tutor.teachingApproach.toLowerCase().includes(searchInput));

            return matchesMajor && matchesSubject && matchesSearch;
        });

        displayTutors(filteredTutors);
        updateStats();
    }

    function resetFilters() {
        document.getElementById('majorFilter').value = '';
        document.getElementById('subjectFilter').value = '';
        document.getElementById('searchInput').value = '';

        filteredTutors = [...allTutors];
        displayTutors(filteredTutors);
        updateStats();
    }

    function updateStats() {
        const totalTutorsEl = document.getElementById('totalTutors');
        const totalSubjectsEl = document.getElementById('totalSubjects');

        if (totalTutorsEl) {
            totalTutorsEl.textContent = filteredTutors.length;
        }
        if (totalSubjectsEl) {
            const uniqueSubjects = [...new Set(filteredTutors.flatMap(t => t.subjects))];
            totalSubjectsEl.textContent = uniqueSubjects.length;
        }
    }

    function showLoading() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('tutorsGrid').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
    }

    function hideLoading() {
        document.getElementById('loading').style.display = 'none';
    }

    function showError(message) {
        const grid = document.getElementById('tutorsGrid');
        grid.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #dc3545;">
        <h3>Oops! Something went wrong</h3>
        <p>${message}</p>
        <button class="btn btn-primary" onclick="loadTutors()" style="margin-top: 1rem;">
          Try Again
        </button>
      </div>
    `;
        grid.style.display = 'grid';
    }

    // Utility functions
    function formatDateTime(dateTimeString) {
        const date = new Date(dateTimeString);
        const options = {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return date.toLocaleDateString('en-US', options);
    }

    function formatTime(dateTimeString) {
        const date = new Date(dateTimeString);
        return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function navigateTo(url) {
        console.log('Navigating to:', url);
        window.location.href = url;
    }

    // User menu functions
    function editProfile() {
        if (!currentUser) return;

        if (currentUser.role === 'TUTOR') {
            navigateTo(`/tutor-profile?userId=${currentUser.id}`);
        } else {
            navigateTo(`/tutee-profile?userId=${currentUser.id}`);
        }
    }

    function toggleUserMenu() {
        const dropdown = document.getElementById('userDropdownMenu');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('currentUser');
            currentUser = null;
            alert('You have been logged out successfully!');
            window.location.href = '/';
        }
    }

    // Close dropdown and modals when clicking outside
    document.addEventListener('click', function(event) {
        // Close user dropdown
        const dropdown = document.getElementById('userDropdownMenu');
        const button = document.querySelector('.user-menu-btn');
        if (dropdown && button && !button.contains(event.target)) {
            dropdown.classList.remove('show');
        }

        // Close booking modal when clicking backdrop
        if (window.currentBookingModal && event.target === window.currentBookingModal) {
            closeBookingModal();
        }

        // Close success modal when clicking backdrop
        if (window.currentSuccessModal && event.target === window.currentSuccessModal) {
            closeSuccessModal();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        // Close modal on Escape
        if (event.key === 'Escape') {
            if (window.currentBookingModal) {
                closeBookingModal();
            }
            if (window.currentSuccessModal) {
                closeSuccessModal();
            }
        }
    });
</script>
</body>
</html>