<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - Qiwi</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #3d3f5c;
      color: #333;
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      font-weight: 400;
    }

    /* NAVBAR - Matching dashboard.html exactly */
    .navbar {
      background: #3d3f5c;
      padding: 1.25rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border-bottom: 1px solid rgba(244, 209, 174, 0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 2rem;
    }

    .logo {
      color: #f4d1ae;
      font-size: 1.5rem;
      font-weight: 700;
      text-decoration: none;
      letter-spacing: -0.02em;
      transition: all 0.3s ease;
    }

    .logo:hover {
      transform: translateY(-2px);
    }

    .nav-links {
      display: flex;
      list-style: none;
      gap: 2rem;
    }

    .nav-links a {
      color: rgba(244, 209, 174, 0.9);
      text-decoration: none;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 0.95rem;
      letter-spacing: -0.01em;
    }

    .nav-links a:hover {
      background-color: rgba(244, 209, 174, 0.15);
      color: #f4d1ae;
      transform: translateY(-1px);
    }

    .nav-links a.active {
      background-color: rgba(244, 209, 174, 0.2);
      color: #f4d1ae;
    }

    /* User Section Styles - Matching dashboard.html */
    .user-section {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-role-badge {
      background: rgba(244, 209, 174, 0.2);
      color: #f4d1ae;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: rgba(244, 209, 174, 0.9);
    }

    .user-dropdown {
      position: relative;
    }

    .user-menu-btn {
      background: rgba(244, 209, 174, 0.1);
      border: 1px solid rgba(244, 209, 174, 0.25);
      color: #f4d1ae;
      padding: 0.6rem 1.25rem;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .user-menu-btn:hover {
      background: rgba(244, 209, 174, 0.15);
      border-color: rgba(244, 209, 174, 0.35);
      transform: translateY(-1px);
    }

    .user-initial {
      background: #f4d1ae;
      color: #3d3f5c;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .user-dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 1000;
      display: none;
      margin-top: 0.5rem;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .user-dropdown-menu.show {
      display: block;
      animation: dropdownFadeIn 0.2s ease;
    }

    @keyframes dropdownFadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-dropdown-menu a {
      display: block;
      padding: 0.875rem 1.25rem;
      color: #374151;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f3f4f6;
    }

    .user-dropdown-menu a:hover {
      background: #f9fafb;
      padding-left: 1.5rem;
    }

    .user-dropdown-menu a:last-child {
      border-bottom: none;
    }

    .logout-link {
      color: #dc2626 !important;
      font-weight: 500;
    }

    .logout-link:hover {
      background: #fef2f2 !important;
    }

    /* Messages Container */
    .messages-container {
      display: flex;
      height: calc(100vh - 80px - 180px);
      max-width: 1400px;
      margin: 0 auto;
      padding: 3rem 32px;
      gap: 3rem;
    }

    /* Conversations Sidebar */
    .conversations-sidebar {
      width: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 2rem;
      border-bottom: 1px solid #e5e7eb;
      background: white;
    }

    .sidebar-header h2 {
      color: #2d3748;
      margin-bottom: 1rem;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    /* UPDATED BUTTON STYLE TO MATCH TUTEE PROFILE */
    .btn {
      display: inline-block;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      text-align: center;
      letter-spacing: -0.01em;
    }

    .btn-primary {
      background: #3d3f5c;
      color: white;
    }

    .btn-primary:hover {
      background: #2d2f3c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(61, 63, 92, 0.3);
    }

    .btn-secondary {
      background: #f9fafb;
      color: #4a5568;
      border: 1px solid #e5e7eb;
    }

    .btn-secondary:hover {
      background: #f3f4f6;
      color: #374151;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      border-color: #cbd5e0;
    }

    .new-conversation-btn {
      width: 100%;
      padding: 1rem 2rem;
      background: #3d3f5c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      text-align: center;
      letter-spacing: -0.01em;
    }

    .new-conversation-btn:hover {
      background: #2d2f3c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(61, 63, 92, 0.3);
    }

    .conversations-list {
      flex: 1;
      overflow-y: auto;
      background: white;
      padding-top: 1rem;
    }

    .conversation-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2rem 1.5rem;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      background: white;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      margin-left: 1.5rem;
      margin-right: 1.5rem;
    }

    .conversation-item:last-child {
      margin-bottom: 1rem;
    }

    .conversation-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-color: #cbd5e0;
    }

    .conversation-item.active {
      background: #f8f9fa;
      border-color: #3d3f5c;
      box-shadow: 0 2px 8px rgba(61, 63, 92, 0.15);
    }

    .conversation-info {
      flex: 1;
    }

    .conversation-info h4 {
      color: #2d3748;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .conversation-name {
      color: #2d3748;
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .conversation-preview {
      color: #4a5568;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      font-weight: 400;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .conversation-time {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #f9fafb;
      color: #2d3748;
      flex-shrink: 0;
    }

    /* Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .chat-header {
      padding: 2rem;
      border-bottom: 1px solid #e5e7eb;
      background: white;
    }

    .chat-header h3 {
      color: #2d3748;
      font-size: 1.1rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin: 0;
    }

    .chat-messages {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      background: #fafbfc;
    }

    .message {
      margin-bottom: 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .message.own {
      flex-direction: row-reverse;
    }

    .message-bubble {
      max-width: 70%;
      padding: 0.875rem 1.25rem;
      border-radius: 12px;
      word-wrap: break-word;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .message.own .message-bubble {
      background: #3d3f5c;
      color: white;
    }

    .message:not(.own) .message-bubble {
      background: white;
      border: 1px solid #e5e7eb;
      color: #374151;
    }

    .message-time {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
      font-weight: 400;
    }

    .message.own .message-time {
      color: rgba(255,255,255,0.8);
    }

    .chat-input {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e5e7eb;
      background: white;
    }

    .input-group {
      display: flex;
      gap: 1rem;
    }

    .message-input {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: #fafbfc;
      font-size: 1rem;
      outline: none;
      font-weight: 400;
      min-height: 2.5rem;
      resize: none;
    }

    .message-input:focus {
      outline: none;
      border-color: #cbd5e0;
      background: white;
      box-shadow: 0 0 0 3px rgba(203, 213, 224, 0.1);
    }

    .send-btn {
      padding: 1rem 2rem;
      background: #3d3f5c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      text-align: center;
      letter-spacing: -0.01em;
    }

    .send-btn:hover {
      background: #2d2f3c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(61, 63, 92, 0.3);
    }

    .send-btn:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .empty-state {
      text-align: center;
      padding: 1.5rem;
      color: #4a5568;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    .empty-state .icon {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
      opacity: 0.6;
      color: #9ca3af;
      font-weight: 600;
    }

    .empty-state p {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .typing-indicator {
      display: none;
      padding: 0.75rem 1.5rem;
      color: #4a5568;
      font-style: italic;
      font-size: 0.9rem;
      background: #f9fafb;
    }

    .disclaimer {
      padding: 1rem;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 6px;
      margin: 1rem 1.5rem;
      font-size: 0.9rem;
      color: #856404;
      line-height: 1.4;
    }

    .disclaimer strong {
      font-weight: 600;
    }

    /* FOOTER - Matching dashboard.html */
    .footer {
      background: #2d3748;
      color: rgba(244, 209, 174, 0.8);
      text-align: center;
      padding: 3rem 0;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 50;
    }

    .footer-content {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 24px;
    }

    .footer-text {
      font-size: 0.9rem;
      color: rgba(244, 209, 174, 0.8);
      margin-bottom: 1.5rem;
      font-weight: 400;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 2.5rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }

    .footer-links a {
      color: rgba(244, 209, 174, 0.9);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .footer-links a:hover {
      color: #f4d1ae;
      transform: translateY(-1px);
    }

    /* Adjust messages container for footer */
    .messages-container {
      height: calc(100vh - 80px - 250px);
    }

    @media (max-width: 768px) {
      .navbar .container {
        flex-wrap: wrap;
        gap: 1rem;
        padding: 0 20px;
      }

      .nav-links {
        order: 3;
        width: 100%;
        justify-content: center;
        gap: 1.5rem;
      }

      .messages-container {
        flex-direction: column;
        padding: 1.5rem 20px;
      }

      .conversations-sidebar {
        width: 100%;
        height: 200px;
        margin-bottom: 1rem;
      }

      .message-bubble {
        max-width: 85%;
      }

      .user-section {
        gap: 1rem;
      }

      .footer {
        position: relative;
      }
    }
  </style>
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
  <div class="container">
    <a href="/" class="logo">Qiwi</a>

    <ul class="nav-links" id="navLinks">
      <li><a href="#" id="dashboardLink">Dashboard</a></li>
      <li><a href="#" id="profileNavLink">My Profile</a></li>
      <li><a href="#" id="browseTutorsLink">Find Tutors</a></li>
      <li><a href="#" id="messagesLink" class="active">Messages</a></li>
    </ul>

    <!-- User Info -->
    <div class="user-section" id="userSection">
      <span class="user-role-badge" id="userRoleBadge">Student</span>
      <div class="user-info">
        <div class="user-dropdown">
          <button class="user-menu-btn" onclick="toggleUserMenu()">
            <div class="user-initial" id="userInitial">U</div>
            <span id="userName">User</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="#" onclick="editProfile()" id="profileLink">Edit Profile</a>
            <a href="#" onclick="logout()" class="logout-link">Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="messages-container">
  <div class="conversations-sidebar">
    <div class="sidebar-header">
      <h2>Messages</h2>
      <button class="new-conversation-btn" onclick="showNewConversationModal()">
        + New Conversation
      </button>
    </div>
    <div class="conversations-list" id="conversationsList">
      <!-- Conversations will be populated by JavaScript -->
    </div>
  </div>

  <div class="chat-area">
    <div id="noChatSelected" class="empty-state" style="background: white; border: none; padding: 3rem;">
      <div class="disclaimer" style="margin: 0 0 2rem 0;">
        <strong>Note:</strong> This is a student-run platform. All arrangements (payment, pricing, and meeting location) should be discussed and managed directly between students. Starting in November, QIWI will handle pricing, payment collection and distribution, as well as conflict resolution. If a conflict arises before November, please send us an email and we will act as an intermediary to help solve the issue.
      </div>
      <div class="icon">Messages</div>
      <p style="font-size: 1.1rem; color: #2d3748; font-weight: 600; margin-bottom: 0.5rem;">Select a conversation</p>
      <p>Choose a conversation from the left to start messaging</p>
    </div>

    <div id="chatActive" style="display: none; height: 100%; display: flex; flex-direction: column;">
      <div class="chat-header">
        <h3 id="chatHeaderName" style="display: none;">Chat</h3>
      </div>

      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be populated by JavaScript -->
      </div>

      <div class="typing-indicator" id="typingIndicator">
        Someone is typing...
      </div>

      <div class="chat-input">
        <div class="input-group">
          <input type="text" id="messageInput" class="message-input"
                 placeholder="Type your message..." onkeypress="handleKeyPress(event)">
          <button class="send-btn" onclick="sendMessage()" id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-content">
    <div class="footer-links">
      <a href="/about">About Qiwi</a>
      <a href="/privacy">Privacy Policy</a>
      <a href="/terms">Terms of Service</a>
      <a href="https://www.linkedin.com/company/qiwiedu/posts/?feedView=all" target="_blank" rel="noopener noreferrer">LinkedIn</a>
      <a href="mailto:support@qiwi.com">Email Us</a>
    </div>
    <p class="footer-text">Â© 2024 Qiwi. Connecting university students through peer tutoring.</p>
  </div>
</footer>

<script th:inline="javascript">
  const userId = /*[[${userId}]]*/ '';
  const API_BASE = '/api';
  let currentUser = null;
  let currentConversation = null;
  let conversations = [];
  let allMessages = [];

  // Get URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const contactId = urlParams.get('contactId');
  const contactName = urlParams.get('contactName');

  // Initialize page
  window.addEventListener('load', function() {
    console.log('Messages page loading with userId:', userId);

    if (!userId) {
      console.log('No userId found, redirecting to login');
      window.location.href = '/login';
      return;
    }

    // Load user data and update navigation
    loadUserData();
    updateNavigation();
    updateUserDisplay();

    // Load conversations and messages
    loadConversations();

    // If contactId is provided, start a conversation
    if (contactId && contactName) {
      startConversationWith(contactId, contactName);
    }
  });

  function loadUserData() {
    try {
      const storedUser = localStorage.getItem('currentUser');
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
        console.log('Loaded user from localStorage:', currentUser);
      } else if (userId) {
        // Create user object from page data
        currentUser = {
          id: userId,
          name: 'Student',
          role: 'TUTEE'
        };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        console.log('Created user object:', currentUser);
      }
    } catch (error) {
      console.error('Error loading user data:', error);
    }
  }

  function updateNavigation() {
    if (!currentUser) {
      console.error('No current user for navigation update');
      return;
    }

    console.log('Updating navigation links');

    const dashboardLink = document.getElementById('dashboardLink');
    const browseTutorsLink = document.getElementById('browseTutorsLink');
    const profileNavLink = document.getElementById('profileNavLink');
    const messagesLink = document.getElementById('messagesLink');

    if (dashboardLink) {
      dashboardLink.href = `/dashboard?userId=${currentUser.id}&role=${currentUser.role || 'TUTEE'}`;
      dashboardLink.onclick = (e) => {
        e.preventDefault();
        navigateTo(`/dashboard?userId=${currentUser.id}&role=${currentUser.role || 'TUTEE'}`);
      };
      console.log('Dashboard link:', dashboardLink.href);
    }

    if (browseTutorsLink) {
      // Update based on user role
      if (currentUser.role === 'TUTOR') {
        browseTutorsLink.textContent = 'Find Students';
        browseTutorsLink.href = `/browse-tutees?userId=${currentUser.id}`;
        browseTutorsLink.onclick = (e) => {
          e.preventDefault();
          navigateTo(`/browse-tutees?userId=${currentUser.id}`);
        };
      } else {
        browseTutorsLink.textContent = 'Find Tutors';
        browseTutorsLink.href = `/browse-tutors?userId=${currentUser.id}`;
        browseTutorsLink.onclick = (e) => {
          e.preventDefault();
          navigateTo(`/browse-tutors?userId=${currentUser.id}`);
        };
      }
      console.log('Browse link:', browseTutorsLink.href);
    }

    if (profileNavLink) {
      profileNavLink.textContent = 'My Profile';
      if (currentUser.role === 'TUTOR') {
        profileNavLink.href = `/tutor-profile?userId=${currentUser.id}`;
        profileNavLink.onclick = (e) => {
          e.preventDefault();
          navigateTo(`/tutor-profile?userId=${currentUser.id}`);
        };
      } else {
        profileNavLink.href = `/tutee-profile?userId=${currentUser.id}`;
        profileNavLink.onclick = (e) => {
          e.preventDefault();
          navigateTo(`/tutee-profile?userId=${currentUser.id}`);
        };
      }
      console.log('Profile link:', profileNavLink.href);
    }

    if (messagesLink) {
      messagesLink.href = `/messages?userId=${currentUser.id}`;
      messagesLink.onclick = (e) => {
        e.preventDefault();
        navigateTo(`/messages?userId=${currentUser.id}`);
      };
      console.log('Messages link:', messagesLink.href);
    }

    console.log('Navigation links updated successfully');
  }

  function updateUserDisplay() {
    if (!currentUser) return;

    const userInitial = document.getElementById('userInitial');
    const userName = document.getElementById('userName');
    const userRoleBadge = document.getElementById('userRoleBadge');
    const profileLink = document.getElementById('profileLink');

    if (userInitial) {
      userInitial.textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
    }

    if (userName) {
      userName.textContent = currentUser.name || 'Student';
    }

    if (userRoleBadge) {
      userRoleBadge.textContent = currentUser.role === 'TUTOR' ? 'Tutor' : 'Student';
    }

    if (profileLink) {
      if (currentUser.role === 'TUTOR') {
        profileLink.href = `/tutor-profile?userId=${currentUser.id}`;
      } else {
        profileLink.href = `/tutee-profile?userId=${currentUser.id}`;
      }
    }
  }

  function navigateTo(url) {
    console.log('Navigating to:', url);
    window.location.href = url;
  }

  async function loadConversations() {
    try {
      const response = await fetch(`${API_BASE}/messages/user/${userId}`);
      if (response.ok) {
        allMessages = await response.json();
        processConversations();
        displayConversations();
        console.log('Loaded conversations:', conversations.length);
      }
    } catch (error) {
      console.error('Error loading conversations:', error);
    }
  }

  function processConversations() {
    const conversationMap = new Map();

    allMessages.forEach(message => {
      const otherUserId = message.sender.id == userId ? message.receiver.id : message.sender.id;
      const otherUserName = message.sender.id == userId ? message.receiver.name : message.sender.name;

      if (!conversationMap.has(otherUserId)) {
        conversationMap.set(otherUserId, {
          userId: otherUserId,
          userName: otherUserName,
          lastMessage: message,
          messages: []
        });
      }

      conversationMap.get(otherUserId).messages.push(message);

      // Update last message if this is more recent
      if (new Date(message.timestamp) > new Date(conversationMap.get(otherUserId).lastMessage.timestamp)) {
        conversationMap.get(otherUserId).lastMessage = message;
      }
    });

    conversations = Array.from(conversationMap.values()).sort((a, b) =>
            new Date(b.lastMessage.timestamp) - new Date(a.lastMessage.timestamp)
    );
  }

  function displayConversations() {
    const list = document.getElementById('conversationsList');

    if (conversations.length === 0) {
      list.innerHTML = `
        <div class="empty-state" style="margin: 1rem;">
          <div class="icon">No Messages</div>
          <p>No conversations yet</p>
          <p style="font-size: 0.9rem; margin-top: 0.5rem;">Start by finding tutors to message!</p>
        </div>
      `;
      return;
    }

    list.innerHTML = conversations.map(conv => `
      <div class="conversation-item" onclick="selectConversation('${conv.userId}', '${conv.userName}')"
           id="conv-${conv.userId}">
        <div class="conversation-info">
          <h4 class="conversation-name">${conv.userName}</h4>
          <div class="conversation-preview">
            ${conv.lastMessage.content.substring(0, 50)}${conv.lastMessage.content.length > 50 ? '...' : ''}
          </div>
        </div>
        <span class="conversation-time">${formatTime(conv.lastMessage.timestamp)}</span>
      </div>
    `).join('');
  }

  function selectConversation(otherUserId, otherUserName) {
    currentConversation = { userId: otherUserId, userName: otherUserName };

    // Update UI
    document.getElementById('noChatSelected').style.display = 'none';
    document.getElementById('chatActive').style.display = 'flex';
    document.getElementById('chatHeaderName').textContent = otherUserName;

    // Highlight selected conversation
    document.querySelectorAll('.conversation-item').forEach(item => {
      item.classList.remove('active');
    });
    document.getElementById(`conv-${otherUserId}`).classList.add('active');

    // Load and display messages
    loadConversationMessages(otherUserId);
  }

  function loadConversationMessages(otherUserId) {
    const conversation = conversations.find(c => c.userId == otherUserId);
    if (!conversation) return;

    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = conversation.messages
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
            .map(message => createMessageHTML(message))
            .join('');

    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function createMessageHTML(message) {
    const isOwn = message.sender.id == userId;
    return `
      <div class="message ${isOwn ? 'own' : ''}">
        <div class="message-bubble">
          ${message.content}
          <div class="message-time">${formatTime(message.timestamp)}</div>
        </div>
      </div>
    `;
  }

  async function sendMessage() {
    if (!currentConversation) return;

    const input = document.getElementById('messageInput');
    const content = input.value.trim();

    if (!content) return;

    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    input.disabled = true;

    try {
      const response = await fetch(`${API_BASE}/messages`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          senderId: parseInt(userId),
          receiverId: parseInt(currentConversation.userId),
          content: content
        })
      });

      if (response.ok) {
        const newMessage = await response.json();

        // Add message to display
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML += createMessageHTML(newMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Clear input
        input.value = '';

        // Update conversations list
        await loadConversations();
        displayConversations();

        // Reselect current conversation
        document.getElementById(`conv-${currentConversation.userId}`).classList.add('active');
      } else {
        alert('Failed to send message. Please try again.');
      }
    } catch (error) {
      console.error('Error sending message:', error);
      alert('An error occurred. Please try again.');
    } finally {
      sendBtn.disabled = false;
      input.disabled = false;
      input.focus();
    }
  }

  function handleKeyPress(event) {
    if (event.key === 'Enter') {
      sendMessage();
    }
  }

  function startConversationWith(otherUserId, otherUserName) {
    // Check if conversation already exists
    const existingConv = conversations.find(c => c.userId == otherUserId);
    if (existingConv) {
      selectConversation(otherUserId, otherUserName);
    } else {
      // Create new conversation
      currentConversation = { userId: otherUserId, userName: otherUserName };

      document.getElementById('noChatSelected').style.display = 'none';
      document.getElementById('chatActive').style.display = 'flex';
      document.getElementById('chatHeaderName').textContent = otherUserName;
      document.getElementById('chatMessages').innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #666;">
          <p>Start your conversation with ${otherUserName}</p>
          <p style="font-size: 0.9rem; margin-top: 0.5rem;">Introduce yourself and let them know what subject you need help with!</p>
        </div>
      `;

      // Focus on input
      document.getElementById('messageInput').focus();
    }
  }

  function showNewConversationModal() {
    // For MVP, redirect to browse tutors
    if (currentUser && currentUser.role === 'TUTOR') {
      navigateTo(`/browse-tutees?userId=${userId}`);
    } else {
      navigateTo(`/browse-tutors?userId=${userId}`);
    }
  }

  function editProfile() {
    if (!currentUser) return;

    if (currentUser.role === 'TUTOR') {
      navigateTo(`/tutor-profile?userId=${currentUser.id}`);
    } else {
      navigateTo(`/tutee-profile?userId=${currentUser.id}`);
    }
  }

  function toggleUserMenu() {
    const dropdown = document.getElementById('userDropdownMenu');
    if (dropdown) {
      dropdown.classList.toggle('show');
    }
  }

  function logout() {
    if (confirm('Are you sure you want to logout?')) {
      localStorage.removeItem('currentUser');
      currentUser = null;
      console.log('User logged out');
      window.location.href = '/';
    }
  }

  function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;

    return date.toLocaleDateString();
  }

  // Auto-refresh messages every 30 seconds
  setInterval(() => {
    if (currentConversation) {
      loadConversations();
    }
  }, 30000);

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('userDropdownMenu');
    const button = document.querySelector('.user-menu-btn');

    if (dropdown && button && !button.contains(event.target)) {
      dropdown.classList.remove('show');
    }
  });

  // Add backup navigation handlers
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up backup navigation handlers');

    // Backup handlers for navigation links
    const navLinks = [
      { id: 'dashboardLink', url: () => `/dashboard?userId=${userId}&role=${currentUser?.role || 'TUTEE'}` },
      { id: 'browseTutorsLink', url: () => currentUser?.role === 'TUTOR' ? `/browse-tutees?userId=${userId}` : `/browse-tutors?userId=${userId}` },
      { id: 'profileNavLink', url: () => currentUser?.role === 'TUTOR' ? `/tutor-profile?userId=${userId}` : `/tutee-profile?userId=${userId}` },
      { id: 'messagesLink', url: () => `/messages?userId=${userId}` }
    ];

    navLinks.forEach(({ id, url }) => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          const targetUrl = url();
          console.log(`Backup navigation for ${id}:`, targetUrl);
          window.location.href = targetUrl;
        });
      }
    });
  });
</script>
</body>
</html>